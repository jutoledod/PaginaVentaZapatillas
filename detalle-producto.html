<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SneakerStore - Detalle Producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Navegación completa y consistente -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-running"></i> SneakerStore
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navDetalle">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navDetalle">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="productos.html">Zapatillas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="blogs.html">Blog</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="nosotros.html">Nosotros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contacto.html">Contacto</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link carrito-btn" href="carrito.html">
                            <i class="fas fa-shopping-cart"></i> (<span id="contador">0</span>)
                        </a>
                    </li>
                    <!-- ADMIN LINK - Solo aparece después de login admin -->
                    <li class="nav-item admin-link">
                        <a class="nav-link" href="admin/home.html">
                            <i class="fas fa-cog"></i> Admin
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Indicador de carga -->
    <div class="loading-indicator d-none" id="loadingDetalle">
        <div class="container py-5">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando producto...</span>
                </div>
                <p class="mt-2 text-muted">Cargando detalles del producto...</p>
            </div>
        </div>
    </div>

    <!-- Detalle del Producto -->
    <div class="container py-5" id="contenido-principal">
        <div id="producto-detalle">
            <!-- Se carga con JavaScript -->
        </div>
        
        <!-- Navegación y acciones -->
        <div class="row mt-5">
            <div class="col-md-6">
                <a href="productos.html" class="btn btn-outline-dark">
                    <i class="fas fa-arrow-left"></i> Volver a Productos
                </a>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-outline-secondary me-2" onclick="compartirProducto()">
                    <i class="fas fa-share-alt"></i> Compartir
                </button>
                <button class="btn btn-outline-primary" onclick="agregarAFavoritos()">
                    <i class="fas fa-heart"></i> Favoritos
                </button>
            </div>
        </div>

        <!-- Productos relacionados -->
        <div id="productos-relacionados" class="mt-5">
            <!-- Se carga con JavaScript -->
        </div>
    </div>

    <!-- Modal de confirmación de agregado -->
    <div class="modal fade" id="modalConfirmacion" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle text-success"></i> ¡Producto agregado!
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">El producto se agregó exitosamente a tu carrito.</p>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Seguir comprando
                        </button>
                        <a href="carrito.html" class="btn btn-primary">
                            <i class="fas fa-shopping-cart"></i> Ver carrito
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/productos.js"></script>
    <script src="js/carrito.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // Variables globales
        let productoActual = null;
        let modalConfirmacion = null;

        // Inicialización mejorada
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Mostrar carga
                mostrarCarga(true);
                
                // Inicializar modal
                modalConfirmacion = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
                
                // Inicializar funciones básicas
                if (typeof cargarCarrito === 'function') {
                    cargarCarrito();
                }
                
                if (typeof verificarSesionAdmin === 'function') {
                    verificarSesionAdmin();
                }

                // Cargar producto con delay para simular carga
                setTimeout(() => {
                    cargarDetalleProducto();
                    mostrarCarga(false);
                }, 400);

            } catch (error) {
                console.error('Error en inicialización:', error);
                mostrarErrorGeneral('Error al cargar la página');
                mostrarCarga(false);
            }
        });

        // Mostrar/ocultar indicador de carga
        function mostrarCarga(mostrar) {
            const loading = document.getElementById('loadingDetalle');
            const contenido = document.getElementById('contenido-principal');
            
            if (loading) {
                loading.classList.toggle('d-none', !mostrar);
            }
            if (contenido) {
                contenido.style.opacity = mostrar ? '0.3' : '1';
                contenido.style.pointerEvents = mostrar ? 'none' : 'auto';
            }
        }

        // Cargar detalle del producto mejorado
        function cargarDetalleProducto() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const productoId = parseInt(urlParams.get('id')) || null;
                
                if (!productoId) {
                    mostrarProductoNoEncontrado('ID de producto no válido');
                    return;
                }

                if (typeof productos === 'undefined' || !Array.isArray(productos)) {
                    throw new Error('Catálogo de productos no disponible');
                }

                const producto = productos.find(p => p.id === productoId);
                
                if (!producto) {
                    mostrarProductoNoEncontrado('Producto no encontrado');
                    return;
                }

                productoActual = producto;
                renderizarDetalleProducto(producto);
                cargarProductosRelacionados(producto);
                actualizarTituloPagina(producto.nombre);
                
            } catch (error) {
                console.error('Error al cargar detalle:', error);
                mostrarErrorGeneral('Error al cargar los detalles del producto');
            }
        }

        // Renderizar detalle del producto
        function renderizarDetalleProducto(producto) {
            const contenedor = document.getElementById('producto-detalle');
            if (!contenedor) return;

            try {
                const stockClass = (producto.stock || 0) <= (producto.stockCritico || 0) ? 'bg-danger' : 'bg-success';
                const stockTexto = (producto.stock || 0) <= 0 ? 'Agotado' : 
                                  (producto.stock || 0) <= (producto.stockCritico || 0) ? 'Stock Crítico' : 'Disponible';
                
                const precioFormateado = (typeof formatearPrecio === 'function') ? 
                    formatearPrecio(producto.precio) : `$${producto.precio}`;
                
                const marcaColor = (typeof getMarcaColor === 'function') ? 
                    getMarcaColor(producto.marca) : 'bg-secondary';

                contenedor.innerHTML = `
                    <nav aria-label="breadcrumb" class="mb-4">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="index.html" style="color: #111;">
                                    <i class="fas fa-home"></i> Inicio
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="productos.html" style="color: #111;">Productos</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">${producto.nombre}</li>
                        </ol>
                    </nav>
                    
                    <div class="row">
                        <!-- Imagen del producto -->
                        <div class="col-lg-6">
                            <div class="producto-imagen-container">
                                <div class="zapatilla-imagen mb-4 position-relative" style="height: 400px; font-size: 8rem; background: #f5f5f5; border-radius: 15px;">
                                    <div class="producto-emoji">👟</div>
                                    ${(producto.stock || 0) <= 0 ? '<div class="overlay-agotado"><span>AGOTADO</span></div>' : ''}
                                </div>
                                
                                <!-- Galería de miniaturas (simulada) -->
                                <div class="d-flex gap-2 justify-content-center">
                                    <div class="miniatura-img active" onclick="cambiarImagen(0)">👟</div>
                                    <div class="miniatura-img" onclick="cambiarImagen(1)">👟</div>
                                    <div class="miniatura-img" onclick="cambiarImagen(2)">👟</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información del producto -->
                        <div class="col-lg-6">
                            <div class="producto-info">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h1 style="font-weight: 700; font-size: 2.2rem;">${producto.nombre}</h1>
                                    <span class="badge ${marcaColor} marca-badge fs-6">${(producto.marca || '').toUpperCase()}</span>
                                </div>
                                
                                <div class="precio-nike mb-3" style="font-size: 2.5rem; color: #111;">
                                    ${precioFormateado}
                                </div>
                                
                                <div class="mb-4">
                                    <span class="badge ${stockClass} fs-6 me-2">
                                        ${stockTexto} (${producto.stock || 0} unidades)
                                    </span>
                                    ${(producto.stock || 0) <= (producto.stockCritico || 0) && (producto.stock || 0) > 0 ? 
                                        '<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> ¡Últimas unidades!</small>' : ''}
                                </div>
                                
                                <div class="mb-4">
                                    <h5><i class="fas fa-info-circle"></i> Descripción</h5>
                                    <p class="text-muted lead">${producto.descripcion || 'Sin descripción disponible'}</p>
                                </div>
                                
                                <div class="mb-4">
                                    <h5><i class="fas fa-list"></i> Detalles técnicos</h5>
                                    <ul class="list-unstyled text-muted">
                                        <li><strong>Código:</strong> <code>${producto.codigo || 'N/A'}</code></li>
                                        <li><strong>Categoría:</strong> ${producto.categoria || 'N/A'}</li>
                                        <li><strong>Marca:</strong> ${producto.marca || 'N/A'}</li>
                                        <li><strong>Género:</strong> Unisex</li>
                                        <li><strong>Material:</strong> Sintético y textil</li>
                                    </ul>
                                </div>
                                
                                <!-- Selector de talla -->
                                <div class="mb-4">
                                    <label class="form-label h5">
                                        <i class="fas fa-ruler"></i> Selecciona tu talla
                                    </label>
                                    <div class="tallas-grid">
                                        <div class="talla-option" data-talla="38">38</div>
                                        <div class="talla-option" data-talla="39">39</div>
                                        <div class="talla-option selected" data-talla="40">40</div>
                                        <div class="talla-option" data-talla="41">41</div>
                                        <div class="talla-option" data-talla="42">42</div>
                                        <div class="talla-option" data-talla="43">43</div>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-question-circle"></i> 
                                        <a href="#" onclick="mostrarGuiaTallas()">Guía de tallas</a>
                                    </small>
                                </div>
                                
                                <!-- Cantidad -->
                                <div class="mb-4">
                                    <label class="form-label h5">
                                        <i class="fas fa-sort-numeric-up"></i> Cantidad
                                    </label>
                                    <div class="cantidad-selector">
                                        <button class="btn btn-outline-secondary" onclick="cambiarCantidad(-1)" ${(producto.stock || 0) <= 0 ? 'disabled' : ''}>
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" class="form-control text-center mx-2" id="cantidad" value="1" min="1" max="${producto.stock || 0}" style="width: 80px;" ${(producto.stock || 0) <= 0 ? 'disabled' : ''}>
                                        <button class="btn btn-outline-secondary" onclick="cambiarCantidad(1)" ${(producto.stock || 0) <= 0 ? 'disabled' : ''}>
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Botones de acción -->
                                <div class="d-grid gap-2">
                                    <button class="btn-nike btn-lg" id="btn-agregar" onclick="agregarAlCarritoDetalle()" ${(producto.stock || 0) <= 0 ? 'disabled' : ''}>
                                        <i class="fas fa-cart-plus"></i> 
                                        ${(producto.stock || 0) <= 0 ? 'Producto Agotado' : 'Agregar al Carrito'}
                                    </button>
                                    
                                    <button class="btn btn-outline-dark btn-lg" onclick="comprarAhora()" ${(producto.stock || 0) <= 0 ? 'disabled' : ''}>
                                        <i class="fas fa-bolt"></i> Comprar Ahora
                                    </button>
                                </div>
                                
                                <!-- Información adicional -->
                                <div class="mt-4 p-3 bg-light rounded">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <i class="fas fa-truck text-primary mb-2 d-block"></i>
                                            <small class="text-muted">Envío gratis<br>sobre $50.000</small>
                                        </div>
                                        <div class="col-4">
                                            <i class="fas fa-undo text-success mb-2 d-block"></i>
                                            <small class="text-muted">Cambios<br>hasta 30 días</small>
                                        </div>
                                        <div class="col-4">
                                            <i class="fas fa-shield-alt text-warning mb-2 d-block"></i>
                                            <small class="text-muted">Garantía<br>de calidad</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Inicializar selectores de talla
                inicializarSelectorTallas();

            } catch (error) {
                console.error('Error al renderizar producto:', error);
                mostrarErrorGeneral('Error al mostrar los detalles del producto');
            }
        }

        // Inicializar selector de tallas
        function inicializarSelectorTallas() {
            const tallas = document.querySelectorAll('.talla-option');
            tallas.forEach(talla => {
                talla.addEventListener('click', function() {
                    tallas.forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        // Agregar al carrito desde detalle
        function agregarAlCarritoDetalle() {
            try {
                if (!productoActual) {
                    mostrarErrorGeneral('Producto no disponible');
                    return;
                }

                const tallaSeleccionada = document.querySelector('.talla-option.selected')?.dataset.talla;
                const cantidad = parseInt(document.getElementById('cantidad')?.value) || 1;

                if (!tallaSeleccionada) {
                    alert('Por favor selecciona una talla');
                    return;
                }

                if (cantidad < 1 || cantidad > (productoActual.stock || 0)) {
                    alert('Cantidad no válida');
                    return;
                }

                // Agregar múltiples unidades
                for (let i = 0; i < cantidad; i++) {
                    if (typeof agregarAlCarrito === 'function') {
                        const resultado = agregarAlCarrito(productoActual.id, tallaSeleccionada);
                        if (!resultado) break;
                    }
                }

                // Mostrar modal de confirmación en lugar de alert
                if (modalConfirmacion) {
                    modalConfirmacion.show();
                }

            } catch (error) {
                console.error('Error al agregar al carrito:', error);
                mostrarErrorGeneral('Error al agregar el producto al carrito');
            }
        }

        // Cambiar cantidad
        function cambiarCantidad(delta) {
            const input = document.getElementById('cantidad');
            if (!input || !productoActual) return;

            const valorActual = parseInt(input.value) || 1;
            const nuevoValor = valorActual + delta;
            const maxStock = productoActual.stock || 0;

            if (nuevoValor >= 1 && nuevoValor <= maxStock) {
                input.value = nuevoValor;
            }
        }

        // Cargar productos relacionados
        function cargarProductosRelacionados(productoActual) {
            try {
                if (typeof productos === 'undefined' || !Array.isArray(productos)) return;

                const relacionados = productos.filter(p => 
                    p.id !== productoActual.id && 
                    (p.categoria === productoActual.categoria || p.marca === productoActual.marca)
                ).slice(0, 4);

                if (relacionados.length === 0) return;

                const contenedor = document.getElementById('productos-relacionados');
                if (!contenedor) return;

                let html = `
                    <h3 class="mb-4"><i class="fas fa-heart"></i> También te puede interesar</h3>
                    <div class="row">
                `;

                relacionados.forEach(producto => {
                    const precioFormateado = (typeof formatearPrecio === 'function') ? 
                        formatearPrecio(producto.precio) : `$${producto.precio}`;
                    
                    const marcaColor = (typeof getMarcaColor === 'function') ? 
                        getMarcaColor(producto.marca) : 'bg-secondary';

                    html += `
                        <div class="col-md-3 mb-4">
                            <div class="card h-100 producto-relacionado" onclick="irAProducto(${producto.id})">
                                <div class="card-img-top d-flex align-items-center justify-content-center" style="height: 200px; background: #f5f5f5; font-size: 3rem;">
                                    👟
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title">${producto.nombre}</h6>
                                    <p class="card-text">
                                        <span class="badge ${marcaColor}">${(producto.marca || '').toUpperCase()}</span>
                                    </p>
                                    <p class="precio-nike">${precioFormateado}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                contenedor.innerHTML = html;

            } catch (error) {
                console.error('Error al cargar productos relacionados:', error);
            }
        }

        // Funciones auxiliares
        function irAProducto(id) {
            window.location.href = `detalle-producto.html?id=${id}`;
        }

        function mostrarProductoNoEncontrado(mensaje) {
            const contenedor = document.getElementById('producto-detalle');
            if (contenedor) {
                contenedor.innerHTML = `
                    <div class="alert alert-warning text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                        <h4>Producto no encontrado</h4>
                        <p>${mensaje}</p>
                        <a href="productos.html" class="btn btn-primary mt-3">
                            <i class="fas fa-arrow-left"></i> Ver todos los productos
                        </a>
                    </div>
                `;
            }
        }

        function mostrarErrorGeneral(mensaje) {
            console.error('Error general:', mensaje);
            // Aquí puedes personalizar cómo mostrar errores
        }

        function actualizarTituloPagina(nombreProducto) {
            if (nombreProducto) {
                document.title = `${nombreProducto} - SneakerStore`;
            }
        }

        function cambiarImagen(index) {
            // Funcionalidad para cambiar imagen principal
            const miniaturas = document.querySelectorAll('.miniatura-img');
            miniaturas.forEach(m => m.classList.remove('active'));
            miniaturas[index]?.classList.add('active');
        }

        function comprarAhora() {
            agregarAlCarritoDetalle();
            setTimeout(() => {
                window.location.href = 'carrito.html';
            }, 500);
        }

        function compartirProducto() {
            if (navigator.share && productoActual) {
                navigator.share({
                    title: productoActual.nombre,
                    text: `Mira estas ${productoActual.nombre} en SneakerStore`,
                    url: window.location.href
                });
            } else {
                // Fallback para navegadores sin Web Share API
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Enlace copiado al portapapeles');
                });
            }
        }

        function agregarAFavoritos() {
            if (productoActual) {
                // Implementar sistema de favoritos
                alert('Producto agregado a favoritos (funcionalidad demo)');
            }
        }

        function mostrarGuiaTallas() {
            alert('Guía de tallas:\n\n38: 24cm\n39: 24.5cm\n40: 25cm\n41: 25.5cm\n42: 26cm\n43: 26.5cm');
        }
    </script>

    <style>
        .loading-indicator {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(2px);
        }

        .producto-emoji {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .overlay-agotado {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
        }

        .overlay-agotado span {
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            transform: rotate(-15deg);
        }

        .miniatura-img {
            width: 60px;
            height: 60px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .miniatura-img:hover, .miniatura-img.active {
            border-color: #111;
            background: #111;
            color: white;
        }

        .tallas-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-width: 350px;
        }

        .talla-option {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            background: white;
        }

        .talla-option:hover {
            border-color: #111;
            background: #f8f9fa;
        }

        .talla-option.selected {
            background: #111;
            color: white;
            border-color: #111;
        }

        .cantidad-selector {
            display: flex;
            align-items: center;
            width: fit-content;
        }

        .producto-relacionado {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .producto-relacionado:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .breadcrumb-item a {
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .tallas-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .producto-info h1 {
                font-size: 1.8rem !important;
            }
            
            .precio-nike {
                font-size: 2rem !important;
            }
        }
    </style>
</body>
</html>
